<div class="chat-container">
  <div class="contacts-list">
    <div class="contacts-header">
      <h2>Chats</h2>
    </div>
    @if (newMessageAlert) {
      @for (userId of getNewMessageUserIds(); track userId) {
        <div class="new-message-alert">
          New message from {{ newMessages[userId].senderName }}: {{ newMessages[userId].content }}
          <button (click)="dismissAlert(userId)">Dismiss</button>
        </div>
      }
    }
    <div class="contacts-scroll">
      @for (user of users; track user.uid) {
        <div class="contact-item" (click)="selectUser(user)" [class.active]="selectedUser?.uid === user.uid">
          <img [src]="user.photoURL || 'assets/Images/user-icon.svg'" [alt]="user.displayName" class="contact-avatar">
          <div class="contact-info">
            <h3>{{ user.displayName }}</h3>
            <p class="latest-message">{{ latestMessages[user.uid] || 'No messages yet' }}</p>
          </div>
          <span class="user-status" [class.online]="user.isOnline" [class.offline]="!user.isOnline">
            â€¢ {{ user.isOnline ? 'Online' : 'Offline' }}
          </span>
        </div>
      }
    </div>
  </div>
  
  <div class="chat-window">
    @if (selectedUser) {
      <div class="chat-header">
        <div class="user-info">
          <img [src]="getSafeImageUrl(selectedUser.photoURL)" [alt]="selectedUser.displayName" class="contact-avatar">
          <div class="user-details">
            <h2>{{ selectedUser.displayName }}</h2>
            <p [class.online]="selectedUser.isOnline">â€¢ {{ selectedUser.isOnline ? 'Online' : 'Offline' }}</p>
          </div>
        </div>
      </div>
      <div class="messages-scroll-container" #messagesContainer>
        <div class="messages-container">
          @for (message of messages; track message.id) {
            <div class="message-wrapper">
              <div class="message" [class.sent]="message.senderId === currentUser?.uid" [class.received]="message.senderId !== currentUser?.uid"
              (click)="toggleMessageTime($event)">
                @if (message.type === 'text') {
                  <p>{{ message.content }}</p>
                } @else if (message.type === 'image') {
                  <img [src]="message.content" alt="Sent image" class="message-image">
                }
              </div>
              <span class="message-time" [class.sent]="message.senderId === currentUser?.uid" [class.received]="message.senderId !== currentUser?.uid">{{ message.timestamp | date:'short' }}</span>
            </div>
          }
        </div>
      </div>
      <div class="message-input">
        <input type="text" [(ngModel)]="newMessage" placeholder="Type a message..." (keyup.enter)="sendMessage()">
        <button (click)="sendMessage()">Send</button>
        <label for="image-upload" class="image-upload-label">ðŸ“·</label>
        <input type="file" id="image-upload" (change)="sendImage($event)" accept="image/*" style="display: none;">
      </div>
    } @else {
      <div class="no-chat-selected">
        <p>Select a user to start chatting</p>
      </div>
    }
  </div>
</div>